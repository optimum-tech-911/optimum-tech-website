import React, { useEffect, useRef, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { useI18n, LANG_OPTIONS } from "../i18n.jsx";
import Hyperspeed from "./Hyperspeed/Hyperspeed.jsx";

 

// Fullscreen, forward-motion hyperspeed intro that locks the site until "Enter" is pressed
export function HyperspeedIntro() {
  
  const [locked, setLocked] = useState(() => !(sessionStorage.getItem("introUnlocked") === "1"));
  const [unlocking, setUnlocking] = useState(false);
  const { lang, setLang, t } = useI18n();
  const [selLang, setSelLang] = useState(lang);
  const [menuOpen, setMenuOpen] = useState(false);
  const FLAG = { fr: "üá´üá∑", en: "üá∫üá∏", es: "üá™üá∏", ar: "üá∏üá¶" };
  const audioNodes = useRef(null);
  const [hyperReady, setHyperReady] = useState(false);
  const startAudio = () => {
    if (audioNodes.current) return;
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioCtx();
    const master = ctx.createGain();
    master.gain.value = 0;
    const compressor = ctx.createDynamicsCompressor();
    compressor.threshold.value = -18;
    compressor.knee.value = 20;
    compressor.ratio.value = 3;
    compressor.attack.value = 0.005;
    compressor.release.value = 0.2;
    master.connect(compressor);
    compressor.connect(ctx.destination);
    const buffer = ctx.createBuffer(1, ctx.sampleRate * 2, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < buffer.length; i++) data[i] = Math.random() * 2 - 1;
    const noise = ctx.createBufferSource();
    noise.buffer = buffer;
    noise.loop = true;
    const bandpass = ctx.createBiquadFilter();
    bandpass.type = "bandpass";
    bandpass.frequency.value = 260;
    bandpass.Q.value = 0.9;
    const lowpass = ctx.createBiquadFilter();
    lowpass.type = "lowpass";
    lowpass.frequency.value = 14000;
    const highpass = ctx.createBiquadFilter();
    highpass.type = "highpass";
    highpass.frequency.value = 30;
    noise.connect(bandpass);
    bandpass.connect(lowpass);
    lowpass.connect(highpass);
    const whooshGain = ctx.createGain();
    whooshGain.gain.value = 0;
    highpass.connect(whooshGain);
    whooshGain.connect(master);
    const osc = ctx.createOscillator();
    osc.type = "sawtooth";
    osc.frequency.value = 80;
    const oscGain = ctx.createGain();
    oscGain.gain.value = 0;
    osc.connect(oscGain);
    oscGain.connect(master);
    const techOsc = ctx.createOscillator();
    techOsc.type = "square";
    techOsc.frequency.value = 420;
    const fm = ctx.createOscillator();
    fm.type = "sine";
    fm.frequency.value = 22;
    const fmGain = ctx.createGain();
    fmGain.gain.value = 55;
    fm.connect(fmGain);
    fmGain.connect(techOsc.frequency);
    const techGain = ctx.createGain();
    techGain.gain.value = 0;
    const techBand = ctx.createBiquadFilter();
    techBand.type = "bandpass";
    techBand.frequency.value = 1800;
    techBand.Q.value = 1.2;
    techOsc.connect(techBand);
    techBand.connect(techGain);
    techGain.connect(master);

    const metalDelay = ctx.createDelay(0.5);
    metalDelay.delayTime.value = 0.009;
    const metalFeedback = ctx.createGain();
    metalFeedback.gain.value = 0.18;
    const metalMix = ctx.createGain();
    metalMix.gain.value = 0;
    bandpass.connect(metalDelay);
    metalDelay.connect(metalFeedback);
    metalFeedback.connect(metalDelay);
    metalDelay.connect(metalMix);
    metalMix.connect(master);
    const lfo = ctx.createOscillator();
    lfo.type = "sine";
    lfo.frequency.value = 0.7;
    const lfoGain = ctx.createGain();
    lfoGain.gain.value = 200;
    lfo.connect(lfoGain);
    lfoGain.connect(bandpass.frequency);
    const meta = { id: "hyperspeed_ship_v2", label: "Hyperspeed Spaceship", version: "2.0", duration: 1.2, author: "Optimum Tech", tags: ["spaceship","hyperspeed","whoosh","futuristic"] };
    audioNodes.current = { ctx, compressor, master, noise, bandpass, lowpass, highpass, whooshGain, osc, oscGain, techOsc, fm, fmGain, techBand, techGain, metalDelay, metalFeedback, metalMix, lfo, lfoGain, meta };
    noise.start();
    osc.start();
    techOsc.start();
    fm.start();
    lfo.start();
  };
  const ensureAudio = async () => {
    if (!audioNodes.current) startAudio();
    const ctx = audioNodes.current.ctx;
    if (ctx.state === "suspended") await ctx.resume();
  };
  const playWhoosh = (dur = 1.2) => {
    if (!audioNodes.current) return;
    const { ctx, master, bandpass, lowpass, highpass, whooshGain, osc, oscGain, techOsc, techGain, techBand, metalMix } = audioNodes.current;
    const t = ctx.currentTime;
    master.gain.cancelScheduledValues(t);
    master.gain.setValueAtTime(0, t);
    master.gain.linearRampToValueAtTime(0.55, t + 0.06);
    master.gain.linearRampToValueAtTime(0, t + dur);
    bandpass.frequency.cancelScheduledValues(t);
    bandpass.frequency.setValueAtTime(260, t);
    bandpass.frequency.exponentialRampToValueAtTime(4200, t + dur * 0.7);
    bandpass.frequency.exponentialRampToValueAtTime(360, t + dur);
    lowpass.frequency.cancelScheduledValues(t);
    lowpass.frequency.setValueAtTime(14000, t);
    lowpass.frequency.linearRampToValueAtTime(9000, t + dur * 0.6);
    highpass.frequency.cancelScheduledValues(t);
    highpass.frequency.setValueAtTime(30, t);
    highpass.frequency.linearRampToValueAtTime(50, t + dur * 0.5);
    oscGain.gain.cancelScheduledValues(t);
    oscGain.gain.setValueAtTime(0, t);
    oscGain.gain.linearRampToValueAtTime(0.22, t + 0.08);
    oscGain.gain.linearRampToValueAtTime(0, t + dur);
    osc.frequency.cancelScheduledValues(t);
    osc.frequency.setValueAtTime(100, t);
    osc.frequency.exponentialRampToValueAtTime(260, t + dur * 0.6);
    osc.frequency.linearRampToValueAtTime(140, t + dur);
    techGain.gain.cancelScheduledValues(t);
    techGain.gain.setValueAtTime(0, t);
    techGain.gain.linearRampToValueAtTime(0.16, t + 0.12);
    techGain.gain.linearRampToValueAtTime(0, t + dur);
    techOsc.frequency.cancelScheduledValues(t);
    techOsc.frequency.setValueAtTime(420, t);
    techOsc.frequency.exponentialRampToValueAtTime(1200, t + dur * 0.7);
    techOsc.frequency.linearRampToValueAtTime(500, t + dur);
    techBand.frequency.cancelScheduledValues(t);
    techBand.frequency.setValueAtTime(1800, t);
    techBand.frequency.linearRampToValueAtTime(2400, t + dur * 0.5);
    whooshGain.gain.cancelScheduledValues(t);
    whooshGain.gain.setValueAtTime(0, t);
    whooshGain.gain.linearRampToValueAtTime(0.5, t + 0.04);
    whooshGain.gain.linearRampToValueAtTime(0, t + dur);
    metalMix.gain.cancelScheduledValues(t);
    metalMix.gain.setValueAtTime(0, t);
    metalMix.gain.linearRampToValueAtTime(0.12, t + 0.18);
    metalMix.gain.linearRampToValueAtTime(0, t + dur);
  };
  const startBoostAudio = () => {
    if (!audioNodes.current) return;
    const { ctx, master, bandpass, lfo, lfoGain, techGain, metalMix } = audioNodes.current;
    const t = ctx.currentTime;
    master.gain.setTargetAtTime(0.38, t, 0.08);
    lfo.frequency.setTargetAtTime(1.3, t, 0.12);
    lfoGain.gain.setTargetAtTime(240, t, 0.2);
    bandpass.Q.setTargetAtTime(1.6, t, 0.12);
    techGain.gain.setTargetAtTime(0.18, t, 0.1);
    metalMix.gain.setTargetAtTime(0.14, t, 0.1);
  };
  const stopBoostAudio = () => {
    if (!audioNodes.current) return;
    const { ctx, master, bandpass, lfo, lfoGain, techGain, metalMix } = audioNodes.current;
    const t = ctx.currentTime;
    master.gain.setTargetAtTime(0.16, t, 0.12);
    lfo.frequency.setTargetAtTime(0.7, t, 0.2);
    lfoGain.gain.setTargetAtTime(200, t, 0.2);
    bandpass.Q.setTargetAtTime(1.0, t, 0.2);
    techGain.gain.setTargetAtTime(0, t, 0.12);
    metalMix.gain.setTargetAtTime(0, t, 0.12);
  };
  useEffect(() => {
    startAudio();
    return () => {
      const n = audioNodes.current;
      if (!n) return;
      try { n.noise.stop(); } catch {}
      try { n.osc.stop(); } catch {}
      try { n.lfo.stop(); } catch {}
      try { n.ctx.close(); } catch {}
      audioNodes.current = null;
    };
  }, []);
  useEffect(() => {
    if (!locked && audioNodes.current) {
      const t = audioNodes.current.ctx.currentTime;
      audioNodes.current.master.gain.setTargetAtTime(0, t, 0.1);
    }
  }, [locked]);

  useEffect(() => {
    if (!locked) return;
    const id = setTimeout(() => {
      if (!hyperReady) { sessionStorage.setItem("introUnlocked","1"); setLocked(false); }
    }, 2500);
    return () => clearTimeout(id);
  }, [locked, hyperReady]);

  

  // color shuffle removed from UI per request; keep state for future presets

  const handleEnter = async () => {
    await ensureAudio();
    playWhoosh(1.2);
    // apply selected language before unlocking
    if (selLang && selLang !== lang) setLang(selLang);
    setUnlocking(true);
    setTimeout(() => {
      sessionStorage.setItem("introUnlocked","1");
      setLocked(false);
    }, 1200);
  };

  return (
    <>
      <AnimatePresence>
        {locked && (
          <motion.div
            key="lock"
            initial={{ opacity: 0, scale: 1, filter: "none" }}
            animate={unlocking ? { opacity: 0, scale: 1.08, filter: "blur(6px) brightness(1.12)" } : { opacity: 1, scale: 1, filter: "none" }}
            transition={{ duration: 1.0, ease: "easeInOut" }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 z-[60] bg-black"
            onMouseDown={async()=>{ await ensureAudio(); startBoostAudio(); }}
            onMouseUp={()=>{ stopBoostAudio(); }}
            onMouseLeave={()=>{ stopBoostAudio(); }}
            onTouchStart={async()=>{ await ensureAudio(); startBoostAudio(); }}
            onTouchEnd={()=>{ stopBoostAudio(); }}
          >
            <div className="absolute inset-0" style={{ background: "radial-gradient(80% 80% at 50% 50%, #0b0b0b, #000000)" }} />
            <Hyperspeed
              effectOptions={{
                onSpeedUp: async () => { await ensureAudio(); startBoostAudio(); },
                onSlowDown: () => { stopBoostAudio(); },
                onInit: () => { setHyperReady(true); },
                onInitError: () => { sessionStorage.setItem("introUnlocked","1"); setLocked(false); }
              }}
            />
            {unlocking && (
              <motion.div
                initial={{ opacity: 0 }}
                animate={{ opacity: [0, 0.6, 0] }}
                transition={{ duration: 0.9, times: [0, 0.35, 1], ease: "easeOut" }}
                className="absolute inset-0"
                style={{
                  background: "radial-gradient(60% 60% at 50% 55%, rgba(255,255,255,0.9), rgba(255,255,255,0) 60%)",
                  mixBlendMode: "screen",
                }}
              />
            )}
            {/* Header bar */}
            <div className="absolute left-1/2 -translate-x-1/2 top-6 z-10 flex items-center gap-3 rounded-full border border-white/10 bg-black/30 px-5 py-2 text-white/80">
              <span className="h-2.5 w-2.5 rounded-full bg-red-500/80" />
              <span className="h-2.5 w-2.5 rounded-full bg-yellow-400/80" />
              <span className="h-2.5 w-2.5 rounded-full bg-green-500/80" />
              <span className="mx-2 text-sm opacity-80">Optimum Tech</span>
            </div>

            {/* Center content */}
            <motion.div
              initial={{ scale: 0.98, y: 10, opacity: 0 }}
              animate={{ scale: unlocking ? 1.06 : 1, y: 0, opacity: 1 }}
              transition={{ duration: 0.6 }}
              className="relative z-10 h-full w-full flex items-center justify-center text-center px-6"
            >
              <div>
                <h2 className="text-5xl md:text-6xl font-extrabold text-white drop-shadow font-pixelify">{t("intro.title")}</h2>
                <p className="mt-3 md:mt-4 text-gray-300 max-w-2xl mx-auto">{t("intro.subtitle")}</p>
                <div className="mt-8 flex items-center justify-center gap-4 relative">
                  <button onClick={handleEnter} className="rounded-full bg-white text-black px-6 py-3 text-sm font-semibold shadow-sm hover:bg-gray-100 active:scale-95">
                    Enter
                  </button>
                  <div className="relative">
                    <button
                      type="button"
                      onClick={() => setMenuOpen((v) => !v)}
                      className="inline-flex items-center justify-center h-11 w-11 rounded-full border border-white/10 bg-white/10 text-xl leading-none backdrop-blur hover:bg-white/20"
                      aria-haspopup="menu"
                      aria-expanded={menuOpen}
                      title="Select language"
                    >
                      {FLAG[selLang] || "üåê"}
                    </button>
                    {menuOpen && (
                      <motion.ul
                        initial={{ opacity: 0, y: -6 }}
                        animate={{ opacity: 1, y: 0 }}
                        exit={{ opacity: 0, y: -6 }}
                        transition={{ duration: 0.15 }}
                        className="absolute right-0 mt-2 w-40 rounded-lg border border-white/10 bg-black/60 backdrop-blur p-1 shadow-lg z-50"
                        role="menu"
                      >
                        {LANG_OPTIONS.map((opt) => (
                          <li key={opt.code}>
                            <button
                              type="button"
                              onClick={() => { setSelLang(opt.code); setMenuOpen(false); }}
                              className={`w-full text-left px-3 py-2 rounded-md text-sm flex items-center gap-2 ${
                                selLang === opt.code ? "bg-white/15 text-white" : "text-gray-200 hover:bg-white/10"
                              }`}
                              role="menuitem"
                            >
                              <span className="text-lg">{FLAG[opt.code] || "üåê"}</span>
                              <span>{opt.label}</span>
                            </button>
                          </li>
                        ))}
                      </motion.ul>
                    )}
                  </div>
                </div>
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>
    </>
  );
}

export default HyperspeedIntro;

